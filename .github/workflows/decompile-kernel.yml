name: Decompile Linux Kernel
on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  push:
    paths:
      - 'kernel.zip'

jobs:
  decompile-kernel:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup decompilation environment
      run: |
        # å®‰è£…å¿…è¦çš„å·¥å…·é“¾
        sudo apt-get update
        sudo apt-get install -y \
          unzip \
          binutils \
          gcc \
          gcc-multilib \
          make \
          flex \
          bison \
          libssl-dev \
          libelf-dev \
          libncurses-dev \
          bc \
          python3 \
          python3-pip \
          device-tree-compiler
          
        # å®‰è£…åç¼–è¯‘å·¥å…·
        pip3 install \
          pyelftools \
          capstone \
          unicorn \
          keystone-engine \
          radare2 \
          lief
        
        # å®‰è£… Ghidraï¼ˆä¸“ä¸šåç¼–è¯‘å·¥å…·ï¼‰
        wget -q https://github.com/NationalSecurityAgency/ghidra/releases/download/Ghidra_11.0.1_build/ghidra_11.0.1_PUBLIC_20231222.zip
        unzip -q ghidra_11.0.1_PUBLIC_20231222.zip -d /opt/
        echo "/opt/ghidra_11.0.1_PUBLIC" >> $GITHUB_PATH
        
    - name: Extract kernel image
      run: |
        # è§£åŽ‹å†…æ ¸æ–‡ä»¶
        unzip -o kernel.zip -d kernel_source/
        
        # æŸ¥æ‰¾å†…æ ¸é•œåƒæ–‡ä»¶
        find kernel_source/ -name "*.img" -o -name "vmlinu*" -o -name "Image*" -o -name "zImage*" | head -5
        
    - name: Identify kernel image type
      run: |
        cd kernel_source/
        
        # ä½¿ç”¨ file å‘½ä»¤è¯†åˆ«æ–‡ä»¶ç±»åž‹
        for file in $(find . -type f \( -name "*.img" -o -name "vmlinu*" -o -name "Image*" -o -name "zImage*" \)); do
          echo "=== åˆ†æžæ–‡ä»¶: $file ==="
          file "$file"
          echo ""
        done
        
    - name: Extract kernel symbols and info
      run: |
        cd kernel_source/
        
        # ä½¿ç”¨ readelf åˆ†æž ELF æ–‡ä»¶
        for file in $(find . -type f -executable -o -name "vmlinu*" -o -name "Image*"); do
          if [ -f "$file" ]; then
            echo "=== åˆ†æž ELF æ–‡ä»¶: $file ==="
            readelf -h "$file" 2>/dev/null && echo "---" && readelf -Ws "$file" 2>/dev/null | head -20 || true
            echo ""
          fi
        done
        
    - name: Decompile with multiple tools
      run: |
        mkdir -p decompiled_output
        
        # æ–¹æ³•1: ä½¿ç”¨ objdump åæ±‡ç¼–
        echo "=== ä½¿ç”¨ objdump åæ±‡ç¼– ==="
        for kernel_file in $(find kernel_source/ -type f \( -name "vmlinux" -o -name "vmlinuz" \)); do
          if [ -f "$kernel_file" ]; then
            objdump -d "$kernel_file" > decompiled_output/objdump_output.txt
            break
          fi
        done
        
        # æ–¹æ³•2: ä½¿ç”¨ radare2 åç¼–è¯‘
        echo "=== ä½¿ç”¨ radare2 åˆ†æž ==="
        for kernel_file in $(find kernel_source/ -type f -name "vmlinu*"); do
          if [ -f "$kernel_file" ]; then
            r2 -q -A -c "pdg > decompiled_output/radare2_decompiled.c" "$kernel_file" 2>/dev/null || true
            break
          fi
        done
        
        # æ–¹æ³•3: æå–å†…æ ¸ç¬¦å·è¡¨
        echo "=== æå–å†…æ ¸ç¬¦å· ==="
        for kernel_file in $(find kernel_source/ -type f -name "System.map"); do
          if [ -f "$kernel_file" ]; then
            cp "$kernel_file" decompiled_output/System.map
            break
          fi
        done
        
    - name: Extract config and modules info
      run: |
        # æŸ¥æ‰¾å†…æ ¸é…ç½®æ–‡ä»¶
        find kernel_source/ -name ".config" -o -name "config.gz" | xargs -I {} cp {} decompiled_output/ 2>/dev/null || true
        
        # å¦‚æžœæ˜¯åŽ‹ç¼©çš„å†…æ ¸ï¼Œå°è¯•æå–
        for file in $(find kernel_source/ -name "*.gz" -o -name "*.xz" -o -name "*.bz2"); do
          echo "å¤„ç†åŽ‹ç¼©æ–‡ä»¶: $file"
          case "$file" in
            *.gz) gunzip -c "$file" > "${file%.gz}" 2>/dev/null || true ;;
            *.xz) unxz -c "$file" > "${file%.xz}" 2/dev/null || true ;;
            *.bz2) bunzip2 -c "$file" > "${file%.bz2}" 2/dev/null || true ;;
          esac
        done
        
    - name: Create decompilation report
      run: |
        echo "# Linux å†…æ ¸åç¼–è¯‘æŠ¥å‘Š" > decompiled_output/REPORT.md
        echo "ç”Ÿæˆæ—¶é—´: $(date)" >> decompiled_output/REPORT.md
        echo "" >> decompiled_output/REPORT.md
        
        echo "## å‘çŽ°çš„å†…æ ¸æ–‡ä»¶" >> decompiled_output/REPORT.md
        find kernel_source/ -type f | sed 's/^/- /' >> decompiled_output/REPORT.md
        echo "" >> decompiled_output/REPORT.md
        
        echo "## æ–‡ä»¶ç±»åž‹åˆ†æž" >> decompiled_output/REPORT.md
        for file in $(find kernel_source/ -type f \( -name "*.img" -o -name "vmlinu*" -o -name "Image*" \)); do
          echo "### $(basename "$file")" >> decompiled_output/REPORT.md
          echo '```' >> decompiled_output/REPORT.md
          file "$file" >> decompiled_output/REPORT.md
          echo '```' >> decompiled_output/REPORT.md
        done
        
    - name: Upload decompilation artifacts
      uses: actions/upload-artifact@v4
      with:
        name: decompiled-kernel
        path: |
          decompiled_output/
        retention-days: 7
        
    - name: Generate summary
      run: |
        echo "## åç¼–è¯‘å®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… å·¥å…·é“¾å®‰è£…å®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… å†…æ ¸æ–‡ä»¶è§£åŽ‹å®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… ä½¿ç”¨å¤šç§å·¥å…·è¿›è¡Œåˆ†æž" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“ è¾“å‡ºæ–‡ä»¶å·²æ‰“åŒ…ä¸º artifact" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**åŒ…å«å†…å®¹ï¼š**" >> $GITHUB_STEP_SUMMARY
        echo "- objdump åæ±‡ç¼–è¾“å‡º" >> $GITHUB_STEP_SUMMARY
        echo "- radare2 åç¼–è¯‘è¾“å‡º" >> $GITHUB_STEP_SUMMARY
        echo "- å†…æ ¸ç¬¦å·è¡¨ï¼ˆå¦‚å­˜åœ¨ï¼‰" >> $GITHUB_STEP_SUMMARY
        echo "- å†…æ ¸é…ç½®æ–‡ä»¶ï¼ˆå¦‚å­˜åœ¨ï¼‰" >> $GITHUB_STEP_SUMMARY
        echo "- è¯¦ç»†åˆ†æžæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY